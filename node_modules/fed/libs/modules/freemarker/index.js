var ftlEngine, ftlRender, path_normalize, renderFile;

path_normalize = require("path").normalize;

ftlEngine = require("./TemplateRun.js");

ftlRender = function(res) {
  return function(tpl, data) {
    res.set('Content-Type', 'text/html');
    return res.render(tpl + '.ftl', data);
  };
};

renderFile = function(path, options, fn) {
  var err, templateName, viewsDir;
  templateName = "";
  viewsDir = path_normalize(options.settings.views);
  templateName = path.replace(viewsDir, "");
  templateName = templateName.replace(/^(\/|\\)/, "");
  try {
    return ftlEngine.processTemplate({
      settings: {
        "encoding": options.settings.fileEncoding || "utf-8",
        "viewFolder": viewsDir
      },
      "fileName": templateName,
      data: options,
      callback: fn
    });
  } catch (_error) {
    err = _error;
    fn(err);
    throw err;
  }
};

exports.init = function() {
  Hub.on("localServer.renderEngine.regist", function(param) {
    var app;
    app = param.app;
    app.engine('ftl', renderFile);
    app.get("render manager").add("ftl", ftlRender);
  });
  return {
    renderFile: renderFile
  };
};
