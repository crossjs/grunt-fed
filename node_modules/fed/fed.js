var CLI, Module, Optimist, Package, argv, cmd, cmdArgs, cmdCli, cmdMap;

Optimist = require("optimist");

Package = require("./package.json");

Module = require("./libs/modules");

cmdMap = Module.initCommand();

CLI = Optimist.usage("Usage:\n  > fed [OPTIONS] <CONFIG_FILE>\n  > fed <SUBCOMMAND> [OPTIONS]\n\nSubCommand:\n  " + (Object.keys(cmdMap))).boolean(["version"]).alias({
  "version": "v",
  "help": "h"
}).describe({
  "help": "Show this message",
  "version": "Show current version info"
});

argv = CLI.argv;

cmd = cmdMap[argv._[0]];

if (cmd) {
  cmdArgs = Optimist.options(cmd.options).argv;
  cmdArgs.$0 += " " + cmdArgs._[0];
  cmdArgs._.shift();
  cmd.fn.call(null, cmdArgs, cmd);
}

if (argv._[0] === "help") {
  if (!argv._[1]) {
    CLI.showHelp();
  } else {
    cmd = cmdMap[argv._[1]];
    if (cmd) {
      cmdCli = Optimist([]).usage("Usage:\n  > fed " + cmd.name + " [OPTIONS]").options(cmd.options).showHelp();
    } else {
      CLI.showHelp();
    }
  }
}

if (argv.help) {
  CLI.showHelp();
  process.exit(0);
}

if (argv.version) {
  console.log(Package.version);
  process.exit(0);
}
